<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>Provider Manager - People First Urgent Care</title>
  <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
  <!-- Base CSS -->
  <link rel="stylesheet" href="assets/css/core/mobile-optimizations.css">
  <link rel="stylesheet" href="assets/css/components/compact-layout.css">
  <link rel="stylesheet" href="assets/css/components/advanced-effects.css">
  <link rel="stylesheet" href="assets/css/components/buttons/action-buttons.css">
  <link rel="stylesheet" href="assets/css/core/custom-redesign.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Header System CSS last -->
  <link rel="stylesheet" href="assets/css/header-system-complete.css">
  <link rel="stylesheet" href="assets/css/layout-fixes.css">
  <style>
    .pm-container{max-width:1100px;margin:0 auto;padding:2rem 1rem}
    .pm-grid{display:grid;grid-template-columns:1fr 1fr;gap:2rem}
    @media (max-width: 900px){.pm-grid{grid-template-columns:1fr}}
    .pm-card{background:#fff;border:1px solid #eaeaea;border-radius:12px;padding:1rem 1.25rem;box-shadow:0 4px 18px rgba(0,0,0,0.05)}
    .pm-card h2{margin:.25rem 0 1rem 0;font-size:1.25rem}
    .pm-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .pm-row.single{grid-template-columns:1fr}
    .pm-row label{font-size:.9rem;color:#4a5568;font-weight:600}
    .pm-row input,.pm-row select,.pm-row textarea{width:100%;padding:.6rem .75rem;border:1px solid #dcdcdc;border-radius:8px}
    .pm-actions{display:flex;gap:.75rem;align-items:center;margin-top:1rem}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem 1rem;border:none;border-radius:8px;cursor:pointer;font-weight:600}
    .btn-primary{background:#05A65C;color:#fff}
    .btn-secondary{background:#e9ecef}
    .badge{display:inline-block;background:#05A65C;color:#fff;border-radius:999px;padding:.25rem .6rem;font-size:.75rem;font-weight:600}
    #providersGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem}
    .provider-card-interactive{position:relative}
    .provider-actions{position:absolute;top:8px;right:8px;display:flex;gap:.4rem}
    .action-btn{background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:6px;padding:.35rem .45rem;cursor:pointer}
    .toolbar{display:flex;gap:.75rem;align-items:center;margin:.75rem 0}
    .toolbar input,.toolbar select{padding:.5rem .6rem;border:1px solid #dcdcdc;border-radius:8px}
    .empty-state{text-align:center;background:#fff;border:1px dashed #cbd5e0;border-radius:12px;padding:2rem}
    /* Live preview card styling */
    .preview-card{background:#fff;border:1px solid #eaeaea;border-radius:12px;padding:1rem;margin-top:1rem}
    .preview-title{font-size:0.9rem;color:#6c757d;margin-bottom:0.75rem;font-weight:600}
    /* Stats styling similar to existing site cards */
    .pm-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;margin:1rem 0}
    .stat-card{background:#fff;border:1px solid #eaeaea;border-radius:12px;padding:1rem;text-align:center;box-shadow:0 4px 18px rgba(0,0,0,0.05)}
    .stat-number{font-size:1.6rem;font-weight:800;color:#05A65C}
    .stat-label{color:#6c757d;font-weight:600}
    /* Enhanced form styling */
    .pm-row input:focus,.pm-row select:focus,.pm-row textarea:focus{border-color:#05A65C;outline:none;box-shadow:0 0 0 3px rgba(5,166,92,0.1)}
    .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
    .btn-primary:hover{background:#048A4F}
    .btn-secondary:hover{background:#dee2e6}
    /* Drag and drop zone */
    .upload-zone{border:2px dashed #cbd5e0;border-radius:12px;padding:1.5rem;text-align:center;transition:all 0.3s ease;cursor:pointer}
    .upload-zone:hover,.upload-zone.dragover{border-color:#05A65C;background:rgba(5,166,92,0.05)}
    .upload-zone.has-file{border-color:#05A65C;background:rgba(5,166,92,0.1)}
    .upload-text{color:#6c757d;font-size:0.9rem;margin-top:0.5rem}
    /* Specialty tags input */
    .specialty-tags{display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.5rem}
    .specialty-tag{background:#e9ecef;color:#495057;padding:0.25rem 0.5rem;border-radius:12px;font-size:0.8rem;display:flex;align-items:center;gap:0.25rem}
    .specialty-tag .remove{cursor:pointer;color:#6c757d}
    .specialty-tag .remove:hover{color:#dc3545}
    /* Toast notifications */
    .toast{position:fixed;top:20px;right:20px;background:#fff;border:1px solid #eaeaea;border-radius:12px;padding:1rem 1.5rem;box-shadow:0 8px 32px rgba(0,0,0,0.15);z-index:1000;transform:translateX(400px);transition:transform 0.3s ease}
    .toast.show{transform:translateX(0)}
    .toast.success{border-left:4px solid #05A65C}
    .toast.error{border-left:4px solid #dc3545}
    /* Enhanced staff card styling for preview */
    .experience-badge{background:linear-gradient(135deg,#17a2b8 0%,#138496 100%);color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;display:inline-block;margin:8px 0}
    .staff-locations,.staff-languages,.staff-education{color:#6c757d;font-size:13px;margin:6px 0;display:flex;align-items:center;gap:6px}
    .staff-locations i,.staff-languages i,.staff-education i{color:#05A65C;width:14px}
    .staff-bio{color:#555;line-height:1.6;margin:12px 0;font-size:14px}
    /* Enhanced specialty badge for preview */
    .staff-specialty-badge{background:linear-gradient(135deg,#05A65C 0%,#048A4F 100%);color:white;padding:8px 16px;border-radius:25px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;display:inline-block;margin-bottom:15px;box-shadow:0 2px 8px rgba(5,166,92,0.3)}
    /* Mobile sticky actions */
    @media (max-width: 768px){
      .pm-actions{position:sticky;bottom:0;background:#fff;border-top:1px solid #eaeaea;margin:-1rem -1.25rem 0;padding:1rem 1.25rem;z-index:10}
    }
  </style>
</head>
<body>
  <div data-include="header"></div>
  <main id="main-content">
    <section class="pm-container">
      <div class="pm-card" style="margin-bottom:1rem">
        <span class="badge">Staff Manager</span>
        <h2>Add or Edit Staff</h2>

        <!-- Quick stats -->
        <div class="pm-stats" aria-hidden="true">
          <div class="stat-card"><div class="stat-number" id="totalStaff">0</div><div class="stat-label">Total Staff</div></div>
          <div class="stat-card"><div class="stat-number" id="medicalProviders">0</div><div class="stat-label">Medical</div></div>
          <div class="stat-card"><div class="stat-number" id="supportStaff">0</div><div class="stat-label">Support</div></div>
          <div class="stat-card"><div class="stat-number" id="specialtyCount">0</div><div class="stat-label">Specialties</div></div>
          <div class="stat-card"><div class="stat-number" id="recentlyAdded">0</div><div class="stat-label">Added (30d)</div></div>
        </div>

        <form id="providerForm" onsubmit="return false;">
          <div class="pm-row">
            <div>
              <label for="providerName">Name</label>
              <input id="providerName" placeholder="e.g., Dr. Jane Smith" required>
            </div>
            <div>
              <label for="providerTitle">Title</label>
              <input id="providerTitle" placeholder="e.g., Medical Director">
            </div>
          </div>
          <div class="pm-row">
            <div>
              <label for="staffType">Staff Type</label>
              <select id="staffType">
                <option value="medical">Medical</option>
                <option value="support">Support</option>
              </select>
            </div>
            <div>
              <label for="providerSpecialty">Primary Specialty</label>
              <input id="providerSpecialty" placeholder="e.g., Urgent Care">
            </div>
          </div>
          <div class="pm-row">
            <div>
              <label for="providerCredentials">Credentials</label>
              <input id="providerCredentials" placeholder="e.g., MD, PA-C">
            </div>
            <div>
              <label for="yearsExperience">Years of Experience</label>
              <input id="yearsExperience" type="number" min="0" max="50" placeholder="e.g., 15">
            </div>
          </div>
          <div class="pm-row">
            <div>
              <label for="providerEmail">Email (optional)</label>
              <input id="providerEmail" type="email" placeholder="doctor@clinic.com">
            </div>
            <div>
              <label for="providerPhone">Phone (optional)</label>
              <input id="providerPhone" type="tel" placeholder="(555) 123-4567">
            </div>
          </div>
          <div class="pm-row">
            <div>
              <label for="linkedinUrl">LinkedIn Profile (optional)</label>
              <input id="linkedinUrl" type="url" placeholder="https://linkedin.com/in/username">
            </div>
            <div>
              <label for="education">Education (optional)</label>
              <input id="education" placeholder="e.g., Harvard Medical School">
            </div>
          </div>
          <div class="pm-row">
            <div>
              <label for="locations">Primary Clinic Locations</label>
              <input id="locations" placeholder="e.g., Downtown, Westside (comma separated)">
            </div>
            <div>
              <label for="languages">Languages Spoken</label>
              <input id="languages" placeholder="e.g., English, Spanish, French">
            </div>
          </div>
          <div class="pm-row">
            <div>
              <label for="providerImage">Photo</label>
              <div class="upload-zone" id="uploadZone">
                <input id="providerImage" type="file" accept="image/*" style="display:none">
                <i class="fa-solid fa-cloud-upload-alt" style="font-size:2rem;color:#6c757d;margin-bottom:0.5rem"></i>
                <div>Click to upload or drag & drop</div>
                <div class="upload-text">JPG, PNG up to 5MB</div>
                <img id="imagePreview" alt="Selected photo preview" style="display:none;max-width:120px;border-radius:10px;margin-top:0.75rem;" />
              </div>
            </div>
          </div>
          <div class="pm-row single">
            <div>
              <label for="providerSpecialties">Additional Specialties (optional)</label>
              <input id="providerSpecialties" placeholder="Type and press Enter to add tags">
              <div class="specialty-tags" id="specialtyTags"></div>
            </div>
          </div>
          <div class="pm-row single">
            <div>
              <label for="providerBio">Bio</label>
              <textarea id="providerBio" rows="4" placeholder="Short biography"></textarea>
            </div>
          </div>
          <div class="pm-actions">
            <button class="btn btn-primary add-provider-btn" type="submit"><i class="fa-solid fa-plus"></i> Add Staff Member</button>
            <button class="btn btn-secondary" type="button" id="cancelBtn" style="display:none">Cancel</button>
            <button class="btn btn-secondary" type="button" id="seedTestBtn">Add Test Provider</button>
          </div>
        </form>

        <!-- Live Preview -->
        <div class="preview-card" id="livePreview" style="display:none">
          <div class="preview-title">Live Preview - How this will appear on Our Staff page:</div>
          <div id="previewContent"></div>
        </div>
      </div>

      <div class="pm-card">
        <div class="toolbar">
          <input id="searchProviders" placeholder="Search providers...">
          <select id="staffTypeFilter">
            <option value="all">All</option>
            <option value="medical">Medical</option>
            <option value="support">Support</option>
          </select>
          <button class="btn btn-secondary" type="button" onclick="providerManager && providerManager.refreshData()">Refresh</button>
          <a href="our-staff.html" class="btn btn-secondary" target="_blank"><i class="fa-solid fa-external-link-alt"></i> View Our Staff</a>
        </div>
        <div id="providersGrid"></div>
      </div>
    </section>
  </main>

  <!-- Header Inline System (file:// compatible) -->
  <script src="assets/js/header-inline.js" defer></script>
  <script src="assets/js/footer-inline.js" defer></script>
  <script src="assets/js/core/header-system-new.js" defer></script>

  <!-- Staff System Scripts -->
  <script src="assets/js/file-staff-manager.js" defer></script>
  <script src="assets/js/provider-file-adapter.js" defer></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    let specialtyTagsData = [];

    // Toast notification system
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<div style="display:flex;align-items:center;gap:0.5rem"><i class="fa-solid fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>${message}</div>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => { toast.classList.remove('show'); setTimeout(() => document.body.removeChild(toast), 300); }, 3000);
    }

    // Drag and drop functionality
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('providerImage');
    const imagePreview = document.getElementById('imagePreview');

    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) { fileInput.files = files; handleImagePreview(files[0]); }
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) handleImagePreview(e.target.files[0]);
    });

    function handleImagePreview(file) {
      if (file && file.type.startsWith('image/')) {
        imagePreview.src = URL.createObjectURL(file);
        imagePreview.style.display = 'block';
        uploadZone.classList.add('has-file');
        updateLivePreview();
      }
    }

    // Specialty tags functionality
    const specialtyInput = document.getElementById('providerSpecialties');
    const specialtyContainer = document.getElementById('specialtyTags');

    specialtyInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.value.trim()) {
        e.preventDefault();
        addSpecialtyTag(e.target.value.trim());
        e.target.value = '';
      }
    });

    function addSpecialtyTag(tag) {
      if (!specialtyTagsData.includes(tag)) {
        specialtyTagsData.push(tag);
        renderSpecialtyTags();
      }
    }

    function removeSpecialtyTag(tag) {
      specialtyTagsData = specialtyTagsData.filter(t => t !== tag);
      renderSpecialtyTags();
    }

    function renderSpecialtyTags() {
      specialtyContainer.innerHTML = specialtyTagsData.map(tag =>
        `<span class="specialty-tag">${tag}<span class="remove" onclick="removeSpecialtyTag('${tag}')">&times;</span></span>`
      ).join('');
      updateLivePreview();
    }

    // Live preview functionality
    function updateLivePreview() {
      const name = document.getElementById('providerName').value;
      const title = document.getElementById('providerTitle').value;
      const type = document.getElementById('staffType').value;
      const specialty = document.getElementById('providerSpecialty').value;
      const credentials = document.getElementById('providerCredentials').value;
      const bio = document.getElementById('providerBio').value;
      const yearsExp = document.getElementById('yearsExperience').value;
      const email = document.getElementById('providerEmail').value;
      const phone = document.getElementById('providerPhone').value;
      const linkedin = document.getElementById('linkedinUrl').value;
      const education = document.getElementById('education').value;
      const locations = document.getElementById('locations').value;
      const languages = document.getElementById('languages').value;

      const preview = document.getElementById('livePreview');
      const content = document.getElementById('previewContent');

      if (name || title || specialty) {
        preview.style.display = 'block';

        const imageSrc = imagePreview.style.display === 'block' ? imagePreview.src : 'assets/images/healthcare-team-professional.jpg';
        const credentialsList = credentials ? credentials.split(',').map(c => c.trim()).filter(Boolean) : [];
        const specialtyList = specialty ? [specialty, ...specialtyTagsData] : specialtyTagsData;
        const locationsList = locations ? locations.split(',').map(l => l.trim()).filter(Boolean) : [];
        const languagesList = languages ? languages.split(',').map(l => l.trim()).filter(Boolean) : [];

        content.innerHTML = `
          <div class="staff-card hover-lift shadow-soft" style="max-width:320px;margin:0 auto">
            <div class="staff-specialty-badge">${specialty || (type === 'medical' ? 'Healthcare Provider' : 'Support Team')}</div>
            <div class="staff-image image-zoom-container">
              <img src="${imageSrc}" alt="${name || 'Staff Member'}" loading="lazy" class="image-zoom" onerror="this.onerror=null; this.src='assets/images/healthcare-team-professional.jpg'">
              <div class="staff-social">
                ${linkedin ? `<a href="${linkedin}" target="_blank" class="social-link hover-scale" aria-label="LinkedIn Profile"><i class="fa-brands fa-linkedin-in"></i></a>` : ''}
                ${email ? `<a href="mailto:${email}" class="social-link hover-scale" aria-label="Email"><i class="fa-solid fa-envelope"></i></a>` : ''}
                ${phone ? `<a href="tel:${phone}" class="social-link hover-scale" aria-label="Phone"><i class="fa-solid fa-phone"></i></a>` : ''}
              </div>
            </div>
            <div class="staff-info">
              <h3 class="staff-name">${name || 'Staff Name'}</h3>
              <p class="staff-title"><i class="fa-solid fa-user-doctor"></i> ${title || 'Job Title'}</p>
              ${yearsExp ? `<div class="experience-badge"><i class="fa-solid fa-clock"></i> ${yearsExp}+ Years Experience</div>` : ''}
              ${credentialsList.length > 0 ? `<div class="staff-credentials">${credentialsList.map(c => `<span class="credential"><i class="fa-solid fa-graduation-cap"></i> ${c}</span>`).join('')}</div>` : ''}
              ${locationsList.length > 0 ? `<div class="staff-locations"><i class="fa-solid fa-map-marker-alt"></i> ${locationsList.join(', ')}</div>` : ''}
              ${languagesList.length > 0 ? `<div class="staff-languages"><i class="fa-solid fa-globe"></i> ${languagesList.join(', ')}</div>` : ''}
              ${bio ? `<p class="staff-bio">${bio}</p>` : ''}
              ${specialtyList.length > 1 ? `<div class="staff-specialties">${specialtyList.slice(1).map(s => `<span class="specialty-tag">${s}</span>`).join('')}</div>` : ''}
              ${education ? `<div class="staff-education"><i class="fa-solid fa-university"></i> ${education}</div>` : ''}
            </div>
          </div>
        `;
      } else {
        preview.style.display = 'none';
      }
    }

    // Add event listeners for live preview updates
    ['providerName', 'providerTitle', 'staffType', 'providerSpecialty', 'providerCredentials', 'providerBio',
     'yearsExperience', 'providerEmail', 'providerPhone', 'linkedinUrl', 'education', 'locations', 'languages'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateLivePreview);
    });

    // Cancel button functionality
    document.getElementById('cancelBtn').addEventListener('click', () => {
      document.getElementById('providerForm').reset();
      imagePreview.style.display = 'none';
      uploadZone.classList.remove('has-file');
      specialtyTagsData = [];
      renderSpecialtyTags();
      document.querySelector('.add-provider-btn').innerHTML = '<i class="fa-solid fa-plus"></i> Add Staff Member';
      document.getElementById('cancelBtn').style.display = 'none';
      updateLivePreview();
    });

    // Simple helper: seed a test provider (no image) using the same API as the form
    document.addEventListener('DOMContentLoaded', function(){
      const seedBtn = document.getElementById('seedTestBtn');
      if (seedBtn) {
        seedBtn.addEventListener('click', async function(){
          try {
            if (!window.fileStaffManager) return showToast('Staff Manager not ready yet. Try again in a second.', 'error');
            await window.fileStaffManager.addStaff({
              name: 'Test Provider',
              title: 'Physician Assistant',
              type: 'medical',
              specialty: 'Urgent Care',
              credentials: 'PA-C',
              bio: ''
            }, null);
            showToast('Test provider added successfully!');
          } catch (e) {
            console.error(e);
            showToast('Failed to add test provider: ' + (e && e.message ? e.message : 'Unknown error'), 'error');
          }
        });
      }

      // Override provider adapter's form submission to include specialty tags and show toasts
      const originalSubmit = window.addEventListener;
      setTimeout(() => {
        if (window.fileStaffManager) {
          const form = document.getElementById('providerForm');
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
              const formData = {
                name: document.getElementById('providerName').value,
                title: document.getElementById('providerTitle').value,
                type: document.getElementById('staffType').value,
                specialty: document.getElementById('providerSpecialty').value,
                credentials: document.getElementById('providerCredentials').value,
                bio: document.getElementById('providerBio').value,
                yearsExperience: document.getElementById('yearsExperience').value,
                email: document.getElementById('providerEmail').value,
                phone: document.getElementById('providerPhone').value,
                linkedinUrl: document.getElementById('linkedinUrl').value,
                education: document.getElementById('education').value,
                locations: document.getElementById('locations').value,
                languages: document.getElementById('languages').value
              };

              // Add specialty tags to bio if any
              if (specialtyTagsData.length > 0) {
                formData.bio += (formData.bio ? '\n\n' : '') + 'Additional Specialties: ' + specialtyTagsData.join(', ');
              }

              const imageFile = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;

              await window.fileStaffManager.addStaff(formData, imageFile);
              showToast('Staff member added successfully!');

              // Reset form
              form.reset();
              imagePreview.style.display = 'none';
              uploadZone.classList.remove('has-file');
              specialtyTagsData = [];
              renderSpecialtyTags();

            } catch (e) {
              console.error(e);
              showToast('Failed to save staff member: ' + (e && e.message ? e.message : 'Unknown error'), 'error');
            }
          });
        }
      }, 1000);
    });
  </script>
</body>
</html>
